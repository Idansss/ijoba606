rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isSelf(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    function hasRole(role) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isModerator() {
      return hasRole('moderator') || hasRole('admin');
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Users collection
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isSelf(uid);
      allow update: if isSelf(uid) || isAdmin();
    }
    
    // Profiles collection
    match /profiles/{uid} {
      allow read: if isSignedIn();
      allow create: if isSelf(uid);
      // Updates normally done via Functions, but allow self for basic fields
      allow update: if isSelf(uid) || isAdmin();
    }
    
    // Questions collection
    match /questions/{qid} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Rounds collection
    match /rounds/{rid} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      // Final scoring done via Functions
      allow update: if false;
    }
    
    // Leaderboards
    match /leaderboards/{scope}/entries/{uid} {
      allow read: if true; // Public read
      allow write: if false; // Only Functions
    }
    
    // Forum Threads
    match /forumThreads/{tid} {
      // Regular users can only read non-hidden threads; moderators/admins can read all
      allow read: if (!('isHidden' in resource.data) || resource.data.isHidden == false) || isModerator();
      allow create: if isSignedIn() && 
                       request.resource.data.uid == request.auth.uid &&
                       request.resource.data.title.size() >= 10 &&
                       request.resource.data.title.size() <= 200 &&
                       request.resource.data.bodyMD.size() >= 20 &&
                       request.resource.data.bodyMD.size() <= 5000 &&
                       request.resource.data.tags.size() >= 1 &&
                       request.resource.data.tags.size() <= 3;
      allow update: if isSelf(resource.data.uid) || isModerator();
      allow delete: if isAdmin();
    }
    
    // Forum Posts
    match /forumPosts/{pid} {
      // Regular users can only read non-hidden posts; moderators/admins can read all
      allow read: if (!('isHidden' in resource.data) || resource.data.isHidden == false) || isModerator();
      allow create: if isSignedIn() && 
                       request.resource.data.uid == request.auth.uid &&
                       request.resource.data.bodyMD.size() >= 10 &&
                       request.resource.data.bodyMD.size() <= 3000;
      allow update: if isSelf(resource.data.uid) || isModerator();
      allow delete: if isAdmin();
    }
    
    // Forum Votes
    match /forumVotes/{kind}/{targetId}/userVotes/{uid} {
      allow read: if isSignedIn();
      allow write: if isSelf(uid); // Users can manage their own votes
    }
    
    // Forum Reports
    match /forumReports/{rid} {
      allow read: if isModerator();
      allow create: if isSignedIn() && request.resource.data.reporterUid == request.auth.uid;
      allow update: if isModerator();
    }
    
    // Forum Tags
    match /forumTags/{tag} {
      allow read: if true;
      allow write: if false; // Only Functions update usage counts
    }
    
    // Forum Subscriptions
    match /forumSubscriptions/{tid}/subscribers/{uid} {
      allow read: if isSelf(uid);
      allow write: if isSelf(uid);
    }
    
    // Notifications
    match /notifications/{uid}/items/{nid} {
      allow read: if isSelf(uid);
      allow write: if false; // Only Functions create notifications
    }
    
    // Calculator Runs
    match /calcRuns/{rid} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if false; // Only via Functions (for validation)
      allow update, delete: if false;
    }
    
    // Configs (PAYE Rules)
    match /configs/{docId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }
    
    // Rate Limits
    match /rateLimits/{uid} {
      allow read, write: if false; // Only Functions
    }
    
    // ==================== Consultants ====================
    
    // Consultant Applications (existing)
    match /consultantApplications/{appId} {
      allow read: if isAdmin() || (isSignedIn() && resource.data.uid == request.auth.uid);
      allow create: if isSignedIn(); // Users can apply (primarily via Functions)
      allow update: if isAdmin(); // Only admins can approve/reject
      allow delete: if isAdmin();
    }
    
    // Consultant Requests (existing)
    match /consultantRequests/{reqId} {
      allow read: if isAdmin();
      allow create: if isSignedIn() || true; // Allow anonymous requests
      allow update, delete: if isAdmin();
    }
    
    // Consultant Profiles (approved consultants)
    match /consultantProfiles/{profileId} {
      allow read: if true; // Public read for discovery
      allow create: if isSignedIn() && 
                       request.resource.data.uid == request.auth.uid &&
                       exists(/databases/$(database)/documents/consultantApplications/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/consultantApplications/$(request.auth.uid)).data.status == 'approved';
      allow update: if isSignedIn() && 
                       (resource.data.uid == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Consultant Chats
    match /consultantChats/{chatId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid);
      allow create: if isSignedIn() && 
                       (request.resource.data.consultantUid == request.auth.uid || 
                        request.resource.data.customerUid == request.auth.uid);
      allow update: if isSignedIn() && 
                       (resource.data.consultantUid == request.auth.uid || 
                        resource.data.customerUid == request.auth.uid);
      allow delete: if false; // Archive instead of delete
    }
    
    // Chat Messages
    match /chatMessages/{messageId} {
      allow read: if isSignedIn() && 
                     exists(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)) &&
                     (get(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)).data.consultantUid == request.auth.uid ||
                      get(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)).data.customerUid == request.auth.uid);
      allow create: if isSignedIn() && 
                       request.resource.data.senderUid == request.auth.uid &&
                       exists(/databases/$(database)/documents/consultantChats/$(request.resource.data.chatId)) &&
                       (get(/databases/$(database)/documents/consultantChats/$(request.resource.data.chatId)).data.consultantUid == request.auth.uid ||
                        get(/databases/$(database)/documents/consultantChats/$(request.resource.data.chatId)).data.customerUid == request.auth.uid);
      allow update: if isSignedIn() && 
                       (resource.data.senderUid == request.auth.uid || 
                        exists(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)) &&
                        (get(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)).data.consultantUid == request.auth.uid ||
                         get(/databases/$(database)/documents/consultantChats/$(resource.data.chatId)).data.customerUid == request.auth.uid));
      allow delete: if false; // Don't allow deletion
    }
    
    // Invoices
    match /invoices/{invoiceId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid);
      allow create: if isSignedIn() && 
                       request.resource.data.consultantUid == request.auth.uid;
      allow update: if isSignedIn() && 
                       (resource.data.consultantUid == request.auth.uid || 
                        (resource.data.customerUid == request.auth.uid && 
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['paymentStatus', 'paystackReference', 'paidAt', 'updatedAt'])));
      allow delete: if isAdmin();
    }
    
    // Payment Transactions
    match /paymentTransactions/{transactionId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid || 
                      isAdmin());
      allow create: if false; // Only Functions create transactions
      allow update: if false; // Only Functions update transactions
      allow delete: if false;
    }
    
    // Bank Accounts
    match /bankAccounts/{accountId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if isSignedIn() && 
                       request.resource.data.uid == request.auth.uid;
      allow update: if isSignedIn() && 
                       (resource.data.uid == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && 
                       (resource.data.uid == request.auth.uid || isAdmin());
    }
    
    // Refund Requests
    match /refundRequests/{refundId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid || 
                      isAdmin());
      allow create: if isSignedIn() && 
                       request.resource.data.customerUid == request.auth.uid;
      allow update: if isAdmin(); // Only admins can process refunds
      allow delete: if false;
    }
    
    // Service Completions
    match /serviceCompletions/{completionId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid || 
                      isAdmin());
      allow create: if isSignedIn(); // Created by consultant or customer
      allow update: if isSignedIn() && 
                       (resource.data.consultantUid == request.auth.uid || 
                        resource.data.customerUid == request.auth.uid || 
                        isAdmin());
      allow delete: if false;
    }
    
    // Disputes
    match /disputes/{disputeId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || 
                      resource.data.customerUid == request.auth.uid || 
                      isAdmin());
      allow create: if isSignedIn() && 
                       request.resource.data.customerUid == request.auth.uid;
      allow update: if isAdmin(); // Only admins can resolve disputes
      allow delete: if false;
    }
    
    // Wallet Transactions
    match /walletTransactions/{transactionId} {
      allow read: if isSignedIn() && 
                     (resource.data.consultantUid == request.auth.uid || isAdmin());
      allow create: if false; // Only Functions create transactions
      allow update: if false; // Only Functions update transactions
      allow delete: if false;
    }
  }
}

